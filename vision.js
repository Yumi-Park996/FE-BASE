document.addEventListener("DOMContentLoaded", async () => {
  const GEMINI_API_KEY = "AIzaSyAL8HHG1ZR89oRwTL86wifc6Hsv49O7JV4";

  // TEST1 ) gemini-1.5-flash
  // âœ… ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ë°˜ë ¤ë™ë¬¼ ì •ë³´ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
  async function findAnimal(base64Image, mimeType) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

    const prompt = `You are the best animal behavior analyst and image recognition expert. The following image contains a pet. Analyze the image thoroughly and provide the most satisfying and detailed answer for the user. Identify the animal's species, breed, color, size, weight, temperament, and any unique characteristics. Focus on key traits typically associated with pets and ensure a high-quality response that meets user expectations.`;

    try {
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                { text: prompt },
                {
                  inline_data: {
                    mime_type: mimeType, // âœ… ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ íŒŒì¼ì˜ MIME íƒ€ì… ìë™ ì„¤ì •
                    data: base64Image, // âœ… Base64 ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ ë°ì´í„°
                  },
                },
              ],
            },
          ],
        }),
      });

      if (!response.ok) {
        throw new Error(
          `API ì˜¤ë¥˜: ${response.status} - ${await response.text()}`
        );
      }

      const result1 = await response.json();
      console.log("ğŸ”¹ Gemini API ì‘ë‹µ:", result);

      if (result1.candidates && result1.candidates.length > 0) {
        return result1.candidates[0].content.parts[0].text;
      } else {
        return "ğŸ”´ ë¶„ì„ ì‹¤íŒ¨: APIê°€ ì‘ë‹µì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }
    } catch (error) {
      console.error("ğŸš¨ Gemini API ìš”ì²­ ì˜¤ë¥˜:", error);
      return "ğŸ”´ ì˜¤ë¥˜ ë°œìƒ: API ìš”ì²­ ì‹¤íŒ¨";
    }
  }

  // TEST2 ) gemini-2.0-flash
  // âœ… ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ë°˜ë ¤ë™ë¬¼ ì •ë³´ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
  async function findAnimal2(base64Image, mimeType, firstprompt) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

    const prompt = `You are the best animal behavior analyst and image recognition expert. The image provided is of a pet. Your task is to analyze the image and generate the most detailed and satisfying response for the user. Identify and describe the animal's type, breed, color, size, weight, temperament, and any distinctive characteristics. Additionally, you will be provided with a text ${firstprompt} that contains an analysis from another model. Your job is to refine, correct, and enhance 'text1' by incorporating your own analysis and insights from the image. Your final response must be a boosted and optimized version that delivers the highest quality answer to the user.`;

    try {
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                { text: prompt },
                {
                  inline_data: {
                    mime_type: mimeType, // âœ… ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ íŒŒì¼ì˜ MIME íƒ€ì… ìë™ ì„¤ì •
                    data: base64Image, // âœ… Base64 ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ ë°ì´í„°
                  },
                },
              ],
            },
          ],
        }),
      });

      if (!response.ok) {
        throw new Error(
          `API ì˜¤ë¥˜: ${response.status} - ${await response.text()}`
        );
      }

      const result2 = await response.json();
      console.log("ğŸ”¹ Gemini API ì‘ë‹µ:", result);

      if (result2.candidates && result2.candidates.length > 0) {
        return result2.candidates[0].content.parts[0].text;
      } else {
        return "ğŸ”´ ë¶„ì„ ì‹¤íŒ¨: APIê°€ ì‘ë‹µì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }
    } catch (error) {
      console.error("ğŸš¨ Gemini API ìš”ì²­ ì˜¤ë¥˜:", error);
      return "ğŸ”´ ì˜¤ë¥˜ ë°œìƒ: API ìš”ì²­ ì‹¤íŒ¨";
    }
  }

  // TEST3 ) gemini-2.0-flash thinking
  // âœ… ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ë°˜ë ¤ë™ë¬¼ ì •ë³´ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
  async function findAnimal3(base64Image, mimeType, secondprompt) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-thinking-exp-01-21:generateContent?key=${GEMINI_API_KEY}`;
    // ê°ì²´ë¥¼ ë°›ì•„ì™€ì„œ

    const prompt = `${secondprompt} is a prompt generated by boosting two models to analyze a pet image. You are the final model in the sequence, possessing superior analytical capabilities compared to the previous two models. The previous sentence should be remembered as context but should not be included in the output.

Utilize '${secondprompt}' and the given pet image to analyze and provide the most detailed and satisfying response for the user. Identify and describe key characteristics of the pet, including species, breed, color, size, weight, temperament, and any unique traits associated with pets.

Ensure that the response is presented in a friendly and engaging tone to enhance user satisfaction. Incorporate emojis to make the response more visually appealing. Additionally, use <br> and \n for line breaks instead of plain text formatting to improve readability. The output should be formatted in HTML instead of Markdown.

The response must be written in Korean and should not exceed 2000 characters.`;

    const choose = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
      }),
    });

    const result3 = await choose.json();
    const finalText = result3.candidates[0].content.parts[0].text;
    console.log(`ë¶„ì„ ê²°ê³¼: ${finalText}`);
    return finalText;
  }

  // âœ… ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  const form = document.querySelector("#controller");
  const formContainer = document.querySelector("#formContainer");
  const spinnerContainer = document.querySelector("#spinnerContainer");
  const resultContainer = document.querySelector("#result");

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    console.log("í¼ ì œì¶œ");
    // âœ… UI ì´ˆê¸°í™”
    const imgBox = document.querySelector("#showImg");
    const content = document.querySelector("#result1");
    const name = document.querySelector("#petName").value;
    content.innerHTML = "";
    imgBox.src = "";

    const input = document.querySelector("#imageInput");

    formContainer.style.display = "none"; // ğŸ”¥ í¼ ìˆ¨ê¹€
    spinnerContainer.style.display = "block"; // ğŸ”¥ ìŠ¤í”¼ë„ˆ í‘œì‹œ

    if (input.files && input.files[0]) {
      const file = input.files[0];
      const mimeType = file.type; // âœ… íŒŒì¼ì˜ MIME íƒ€ì… ìë™ ê°ì§€
      console.log(`ğŸŸ¢ ì„ íƒí•œ íŒŒì¼ MIME íƒ€ì…: ${mimeType}`);

      const reader = new FileReader();

      reader.onloadend = async () => {
        const base64Image = reader.result.split(",")[1]; // âœ… "data:image/jpeg;base64,..."ì—ì„œ Base64 ë¶€ë¶„ë§Œ ì¶”ì¶œ

        try {
          console.log("ğŸ”„ ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...");
          const finalAnswer = await findAnimal(base64Image, mimeType);
          const finalAnswer2 = await findAnimal2(
            base64Image,
            mimeType,
            finalAnswer
          );
          const finalAnswer3 = await findAnimal3(
            base64Image,
            mimeType,
            finalAnswer2
          );

          console.log(finalAnswer);
          console.log(finalAnswer2);
          const result3 = document.createElement("p");

          spinnerContainer.style.display = "none";
          resultContainer.style.display = "block";
          imgBox.src = reader.result;

          result3.innerHTML = `ğŸ“Œ ${name} ë¶„ì„ ê²°ê³¼ : ${finalAnswer3}`;
          content.appendChild(result3);
        } catch (error) {
          console.error("ğŸš¨ ì˜¤ë¥˜ ë°œìƒ:", error);
          content.innerText =
            "ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”";
          spinnerContainer.style.display = "none";
          formContainer.style.display = "block";
        }
      };

      reader.readAsDataURL(file);
    } else {
      alert("ğŸš¨ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      content.innerText =
        "ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”";
      spinnerContainer.style.display = "none";
      formContainer.style.display = "block";
    }
  });
});
